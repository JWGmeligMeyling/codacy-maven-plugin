<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CodacyCoverageReporterMojo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">codacy-maven-plugin Maven Plugin</a> &gt; <a href="index.source.html" class="el_package">com.gavinmogan</a> &gt; <span class="el_source">CodacyCoverageReporterMojo.java</span></div><h1>CodacyCoverageReporterMojo.java</h1><pre class="source lang-java linenums">package com.gavinmogan;

import com.codacy.api.CoverageReport;
import com.codacy.api.Language;
import com.codacy.api.helpers.vcs.GitClient;
import com.codacy.parsers.XMLCoverageParser;
import com.codacy.parsers.implementation.CoberturaParser;
import com.codacy.parsers.implementation.JacocoParser;
import com.codacy.transformation.PathPrefixer;
import com.google.common.base.Strings;
import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.ResponseHandler;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.util.EntityUtils;
import org.apache.maven.plugin.AbstractMojo;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugin.MojoFailureException;
import org.apache.maven.plugins.annotations.LifecyclePhase;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.plugins.annotations.Parameter;
import play.api.libs.json.Json;
import scala.Enumeration;

import java.io.File;
import java.io.IOException;
import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationTargetException;

@Mojo( name = &quot;coverage&quot;, defaultPhase = LifecyclePhase.POST_INTEGRATION_TEST)
<span class="fc" id="L35">public class CodacyCoverageReporterMojo extends AbstractMojo</span>
{

    /**
     * your project API token
     */
    @Parameter( defaultValue=&quot;${env.CODACY_PROJECT_TOKEN}&quot;, property = &quot;projectToken&quot;, required = true )
    private String projectToken;

    /**
     * your API token
     */
    @Parameter( defaultValue=&quot;${env.CODACY_API_TOKEN}&quot;, property = &quot;apiToken&quot;, required = true )
    private String apiToken;

    /**
     * your project language
     */
    @Parameter( defaultValue=&quot;Java&quot;, property = &quot;language&quot;, required = true )
    private String language;

    /**
     * your project coverage file name
     */
    @Parameter( defaultValue = &quot;${env.CI_COMMIT}&quot;, property = &quot;commit&quot;, required = false )
    private String commit;

    /**
     * your project coverage file name
     */
    @Parameter( defaultValue=&quot;&quot;, property = &quot;coverageReportFile&quot;, required = true )
    private File coverageReportFile;


    @Parameter( defaultValue=&quot;${project.basedir}&quot;, property = &quot;rootProjectDir&quot;, required = true )
    private File rootProjectDir;

    /**
     * the project path prefix
     */
    @Parameter( defaultValue=&quot;&quot;, property = &quot;prefix&quot;, required = false )
    private String prefix;

    /**
     * the base URL for the Codacy API
     */
    @Parameter( defaultValue=&quot;https://api.codacy.com&quot;, property = &quot;codacyApiBaseUrl&quot;, required = true )
    private String codacyApiBaseUrl;

    @Override
    public void execute() throws MojoFailureException, MojoExecutionException {
        /* TODO
         * loop through ${project.basedir}/target/jacoco/jacoco.xml and ${project.basedir}/target/cobertura/coverage.xml
         * to see which one is available by default?
         */
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">        if (Strings.isNullOrEmpty(commit)) {</span>
<span class="nc" id="L91">            GitClient gitClient = new GitClient(rootProjectDir);</span>
<span class="nc" id="L92">            commit = gitClient.latestCommitUuid().get();</span>
        }

<span class="fc" id="L95">        Enumeration.Value lang = Language.withName(language);</span>

<span class="fc" id="L97">        getLog().debug(&quot;Project token: &quot; + projectToken);</span>

<span class="fc" id="L99">        getLog().info(&quot;Parsing coverage data... &quot; + coverageReportFile);</span>

<span class="fc" id="L101">        CoverageReport report = processReport(lang, rootProjectDir, coverageReportFile);</span>

<span class="pc bpc" id="L103" title="1 of 2 branches missed.">        if (!Strings.isNullOrEmpty(prefix)) {</span>
<span class="nc" id="L104">            final PathPrefixer pathPrefixer = new PathPrefixer(prefix);</span>
<span class="nc" id="L105">            report = pathPrefixer.execute(report);</span>
        }

        try {
<span class="fc" id="L109">            getLog().info(&quot;Uploading coverage data...&quot;);</span>
<span class="fc" id="L110">            postReport(report);</span>
<span class="fc" id="L111">            getLog().info(&quot;Coverage data uploaded&quot;);</span>
<span class="nc" id="L112">        } catch (IOException e) {</span>
<span class="nc" id="L113">            getLog().error(&quot;Failed to upload data.&quot;, e);</span>
<span class="nc" id="L114">            throw new MojoFailureException(&quot;Failed to upload data. Reason: &quot; + e.getMessage(), e);</span>
<span class="fc" id="L115">        }</span>
<span class="fc" id="L116">    }</span>

    public String postReport(CoverageReport report) throws IOException {
<span class="fc" id="L119">        CloseableHttpClient httpclient = HttpClients.createDefault();</span>

        try {
<span class="fc" id="L122">            HttpPost httppost = new HttpPost(codacyApiBaseUrl + &quot;/2.0/coverage/&quot; + commit + &quot;/&quot; + language.toLowerCase());</span>
<span class="fc" id="L123">            httppost.setHeader(&quot;api_token&quot;, apiToken);</span>
<span class="fc" id="L124">            httppost.setHeader(&quot;project_token&quot;, projectToken);</span>
<span class="fc" id="L125">            httppost.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>

<span class="fc" id="L127">            final String json = Json.toJson(report, CoverageReport.codacyCoverageReportFmt()).toString();</span>

<span class="fc" id="L129">            StringEntity input = new StringEntity(json);</span>
<span class="fc" id="L130">            input.setContentType(&quot;application/json&quot;);</span>
<span class="fc" id="L131">            httppost.setEntity(input);</span>

            // Create a custom response handler
<span class="fc" id="L134">            ResponseHandler&lt;String&gt; responseHandler = new ResponseHandler&lt;String&gt;() {</span>

                @Override
                public String handleResponse(final HttpResponse response) throws IOException {
<span class="fc" id="L138">                    int status = response.getStatusLine().getStatusCode();</span>
<span class="pc bpc" id="L139" title="2 of 4 branches missed.">                    if (status &gt;= 200 &amp;&amp; status &lt; 300) {</span>
<span class="fc" id="L140">                        HttpEntity entity = response.getEntity();</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">                        return entity != null ? EntityUtils.toString(entity) : null;</span>
                    } else {
<span class="nc" id="L143">                        throw new ClientProtocolException(&quot;Unexpected response status: &quot; + status);</span>
                    }
                }

            };
<span class="fc" id="L148">            return httpclient.execute(httppost, responseHandler);</span>
        } finally {
<span class="nc" id="L150">            try {</span>
<span class="pc" id="L151">                httpclient.close();</span>
<span class="nc" id="L152">            } catch (IOException e) {</span>
<span class="nc" id="L153">                e.printStackTrace();</span>
<span class="pc" id="L154">            }</span>
        }
    }

<span class="fc" id="L158">    private static Class[] parsers = new Class[] { CoberturaParser.class, JacocoParser.class };</span>

    /**
     * Given a report file, find the parser that works for this
     *
     * @param language What language is this?
     * @param rootProject Where is the project located
     * @param reportFile Where is the coverage report file
     * @return Completed report, or null if nothing matches
     */
    public static CoverageReport processReport(Enumeration.Value language, File rootProject, File reportFile) {

<span class="pc bpc" id="L170" title="1 of 2 branches missed.">        for (Class clazz : parsers) {</span>
            try {
<span class="fc" id="L172">                Constructor con = clazz.getConstructor(Enumeration.Value.class, File.class, File.class);</span>
<span class="fc" id="L173">                XMLCoverageParser parser = (XMLCoverageParser) con.newInstance(language, rootProject, reportFile);</span>

<span class="pc bpc" id="L175" title="1 of 2 branches missed.">                if (parser == null) { continue; }</span>

<span class="fc bfc" id="L177" title="All 2 branches covered.">                if (parser.isValidReport()) {</span>
<span class="fc" id="L178">                    return parser.generateReport();</span>
                }
<span class="nc" id="L180">            } catch (NoSuchMethodException e) {</span>
<span class="nc" id="L181">            } catch (InstantiationException e) {</span>
<span class="nc" id="L182">            } catch (IllegalAccessException e) {</span>
<span class="nc" id="L183">            } catch (InvocationTargetException e) {</span>
<span class="pc" id="L184">            }</span>
        }
<span class="nc" id="L186">        return null;</span>
    }

    public void setCoverageReportFile(File coverageReportFile) {
<span class="fc" id="L190">        this.coverageReportFile = coverageReportFile;</span>
<span class="fc" id="L191">    }</span>

    public void setProjectToken(String projectToken) {
<span class="fc" id="L194">        this.projectToken = projectToken;</span>
<span class="fc" id="L195">    }</span>

    public void setApiToken(String apiToken) {
<span class="fc" id="L198">        this.apiToken = apiToken;</span>
<span class="fc" id="L199">    }</span>

    public void setLanguage(String language) {
<span class="fc" id="L202">        this.language = language;</span>
<span class="fc" id="L203">    }</span>

    public void setRootProjectDir(File rootProjectDir) {
<span class="fc" id="L206">        this.rootProjectDir = rootProjectDir;</span>
<span class="fc" id="L207">    }</span>

    public void setPrefix(String prefix) {
<span class="nc" id="L210">        this.prefix = prefix;</span>
<span class="nc" id="L211">    }</span>

    public void setCodacyApiBaseUrl(String codacyApiBaseUrl) {
<span class="fc" id="L214">        this.codacyApiBaseUrl = codacyApiBaseUrl;</span>
<span class="fc" id="L215">    }</span>

    public void setCommit(String commit) {
<span class="fc" id="L218">        this.commit = commit;</span>
<span class="fc" id="L219">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>